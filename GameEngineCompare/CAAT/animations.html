<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>

<canvas id="experiment-canvas"></canvas>

</body>
<script src="src/Core/ModuleManager.js"></script>
<script>
    window.addEventListener('load',load,false);

    function load() {
        CAAT.ModuleManager.
                baseURL("src/").
                setModulePath("CAAT.Core",              "Core").
                setModulePath("CAAT.Math",              "Math").
                setModulePath("CAAT.Behavior",          "Behavior").
                setModulePath("CAAT.Foundation",        "Foundation").
                setModulePath("CAAT.Event",             "Event").
                setModulePath("CAAT.PathUtil",          "PathUtil").
                setModulePath("CAAT.Module",            "Modules").
                setModulePath("CAAT.Module.Preloader",  "Modules/Image/Preloader").
                setModulePath("CAAT.WebGL",             "WebGL").

            // get modules, and solve their dependencies.
                bring(
                [
                    "CAAT.PathUtil.Path",
                    "CAAT.PathUtil.LinearPath",
                    "CAAT.Foundation.SpriteImage",
                    "CAAT.Foundation.Director",
                    "CAAT.Foundation.Actor",
                    "CAAT.Foundation.ActorContainer",
                    "CAAT.Behavior.PathBehavior",
                    "CAAT.Behavior.Interpolator",
                    "CAAT.Module.Preloader.Preloader"
                ]).

            // this function will be firer every time all dependencies have been solved.
            // if you call again bring, this function could be fired again.
                onReady(function () {
                    // simply load js files. call start when all of them have been loaded.
                    // load won't start until all 'bring' dependencies have been solved.

                    new CAAT.Module.Preloader.Preloader().
                            addElement("fish",  "../resources/anim1.png").
                            addElement("fish2", "../resources/anim2.png").
                            addElement("fish3", "../resources/anim3.png").
                            addElement("fish4", "../resources/anim4.png").
                            load( function onAllAssetsLoaded(images) {
                                sprites(images);
                            } );

                });
    }
    function sprites(images) {
        CAAT.DEBUG= 1;
        var director= new CAAT.Foundation.Director().initialize( 800,500,'experiment-canvas' );
        director.setImagesCache(images);
        var scene= director.createScene();
        // when the scene is activated, avoid the director clearing the viewport since it'll be
        // totally erased by the background.
        scene.activated= function() {
            director.setClear(false);
        }

        var imageIndex=0;
        var conpoundimagefish = [];
        conpoundimagefish.push(
                new CAAT.Foundation.SpriteImage().initialize(
                        director.getImage('fish'),  1, 3) );
        conpoundimagefish.push(
                new CAAT.Foundation.SpriteImage().initialize(
                        director.getImage('fish2'), 1, 3) );
        conpoundimagefish.push(
                new CAAT.Foundation.SpriteImage().initialize(
                        director.getImage('fish3'), 1, 3) );
        conpoundimagefish.push(
                new CAAT.Foundation.SpriteImage().initialize(
                        director.getImage('fish4'), 1, 3) );

        function addFish(x,y) {

            var scale= Math.random() + .5;

            var fish = new CAAT.Foundation.Actor().
                    setBackgroundImage(
                    conpoundimagefish[(imageIndex++)%conpoundimagefish.length],
                    true).
                    setLocation( x,y ).
                    setScale( scale,scale ).
                        setAnimationImageIndex( [0,1,2,1] ).
                        setChangeFPS(300).
                    enableEvents(false);

            scene.addChild(fish);
        }

        var gradient= director.ctx.createLinearGradient(0,0,director.width,director.height);
        gradient.addColorStop(0,'#000000');
        gradient.addColorStop(1,'#00007f');

        var gr= new CAAT.Foundation.ActorContainer().
                setBounds(0,0,director.width,director.height).
                setFillStyle(gradient).
                enableEvents(false).
                cacheAsBitmap();

        scene.addChild(gr);

        gr.enableEvents(true);
        gr.mouseClick= function(ev) {
            addFish(ev.point.x,ev.point.y);
        };


        console.time("add 5000 Sprites");
        for(var i=0;i<5000;i++){
            addFish(100,100);
        }

        console.timeEnd("add 5000 Sprites");


        CAAT.loop(60);
    }
</script>
</html>